<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>URBAN SHOP - All Products</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link rel="stylesheet" href="css/style.css">
</head>
<body>

<header>
  <div class="logo"><img src="Images/barnd1.png" class="brand">&nbsp; URBAN SHOP</div>

  <div class="auth-buttons" id="auth-area">
    <button class="auth-btn" id="login-btn" onclick="window.location.href='login.html'">Login</button>
    <button class="auth-btn register" id="register-btn" onclick="window.location.href='register.html'">Register</button>
  </div>

  <div id="user-area" style="display:none;">
    <span id="welcome-text"></span>

    <div id="cart-icon" style="cursor:pointer;">
      <i class="fa-solid fa-cart-shopping"></i>
      <span id="cart-count">0</span>
    </div>

    <button class="auth-btn" id="logout-btn">Logout</button>
  </div>
</header>

<div class="search-bar">
  <select id="search-type">
    <option value="name">Search by Product Name</option>
    <option value="category">Search by Category</option>
  </select>
  <input type="text" id="search-input" placeholder="Search...">
  <button class="btn" id="search-button">Search</button>
</div>

<h1>Our Products</h1>

<!-- Cart Popup -->
<div id="cart-popup" style="display:none;">
  <h2>Cart</h2>
  <ul id="cart-items"></ul>
  <p><strong>Total: <span id="cart-total">€0.00</span></strong></p>
  <button id="add-all-products-btn" class="btn">Add All Products</button>
  <button id="favorite-products-btn" class="btn">Favorite Products</button>
</div>

<div class="grid" id="productGrid"></div>

<script>
// --- Products ---
const products = [
  { name: "Wireless Headphones", price: 59.99, category: "Electronics", image: "Images/headphones.jpg" },
  { name: "Smartwatch Pro", price: 129.00, category: "Electronics", image: "Images/Smartwatch_Pro.avif" },
  { name: "Running Shoes", price: 75.50, category: "Fashion", image: "Images/Running_Shoes.webp" },
  { name: "Leather Backpack", price: 89.90, category: "Accessories", image: "Images/Leather_Backpack.jpg" },
  { name: "Bluetooth Speaker", price: 45.00, category: "Electronics", image: "Images/Bluetooth_Speaker.jpg" },
  { name: "Sunglasses Classic", price: 29.99, category: "Accessories", image: "Images/Sunglasses_Classic.jpg" },
  { name: "Casual T-Shirt", price: 19.95, category: "Fashion", image: "Images/Casual_T-Shirt.jpg" },
  { name: "Office Chair", price: 149.00, category: "Furniture", image: "Images/Office_Chair.webp" },
  { name: "Coffee Maker", price: 99.00, category: "Home Appliances", image: "Images/Coffee_Maker.webp" }
];

const grid = document.getElementById("productGrid");
const cartIcon = document.getElementById("cart-icon");
const cartPopup = document.getElementById("cart-popup");
const cartCount = document.getElementById("cart-count");
const cartItems = document.getElementById("cart-items");
const cartTotal = document.getElementById("cart-total");

// favorites (persisted)
let favorites = JSON.parse(localStorage.getItem("favorites")) || [];
let cart = JSON.parse(localStorage.getItem("cart")) || [];

// --- Helper: check login ---
function getCurrentUser() {
  return JSON.parse(localStorage.getItem("currentUser") || sessionStorage.getItem("currentUser") || "null");
}
function requireLogin() {
  const user = getCurrentUser();
  if (!user) {
    alert("⚠️ You must register or login before ordering.");
    window.location.href = "login.html";
    return false;
  }
  return true;
}

// --- Render Products ---
function renderProducts(productList) {
  grid.innerHTML = "";
  productList.forEach((product, index) => {
    const inCart = cart.some(p => p.name === product.name);
    const isFav = favorites.includes(product.name);

    const card = document.createElement("div");
    card.classList.add("card");
    card.innerHTML = `
      <img src="${product.image}" alt="${product.name}">
      <h3>${product.name}</h3>
      <p class="price">€${product.price.toFixed(2)}</p>
      <p>${product.category}</p>

      <div class="card-actions" style="display:flex; gap:8px; align-items:center;">
        <button class="btn product-btn ${inCart ? "in-cart" : ""}" data-index="${index}">
          ${inCart ? "Remove from Cart" : "Add to Cart"}
        </button>
        <button class="heart-btn" data-index="${index}" aria-label="Favorite" title="Add to favorites" style="border:none; background:transparent; cursor:pointer; font-size:18px;">
          <i class="${isFav ? 'fa-solid' : 'fa-regular'} fa-heart" style="${isFav ? 'color:red;' : ''}"></i>
        </button>
      </div>
    `;
    grid.appendChild(card);
  });
}
renderProducts(products);

// --- Cart Functions ---
function isInCart(product) { return cart.some(item => item.name === product.name); }
function addToCart(product) {
  const found = cart.find(item => item.name === product.name);
  if(found) found.quantity++;
  else cart.push({...product, quantity:1});
  saveCart();
}
function removeFromCart(product) {
  cart = cart.filter(item => item.name !== product.name);
  saveCart();
}
function saveCart() {
  localStorage.setItem("cart", JSON.stringify(cart));
  updateCartUI();
  renderProducts(products);
}
function updateCartUI() {
  cartItems.innerHTML = "";
  let total = 0;
  if(cart.length===0) {
    cartItems.innerHTML = "<li>Your cart is empty.</li>";
  } else {
    cart.forEach((item,index)=>{
      const li = document.createElement("li");
      li.innerHTML = `
        <div class="cart-line">
          <span class="cart-name">${item.name}</span>
          <span class="cart-price">€${item.price.toFixed(2)}</span>
        </div>
        <div class="quantity-controls">
          <button class="decrease" data-index="${index}" aria-label="Decrease">-</button>
          <span class="qty">${item.quantity}</span>
          <button class="increase" data-index="${index}" aria-label="Increase">+</button>
        </div>
      `;
      cartItems.appendChild(li);
      total += item.price * item.quantity;
    });
  }
  cartCount.textContent = cart.reduce((sum,i)=>sum+i.quantity,0);
  cartTotal.textContent = "€"+total.toFixed(2);
}

// --- Event Delegation ---
document.addEventListener("click",(e)=>{
  // product add/remove
  if(e.target.classList.contains("product-btn") || e.target.closest('.product-btn')) {
    if(!requireLogin()) return;

    const btn = e.target.classList.contains("product-btn") ? e.target : e.target.closest('.product-btn');
    const idx = parseInt(btn.getAttribute("data-index"),10);
    const product = products[idx];

    if(isInCart(product)) {
      removeFromCart(product);
      btn.textContent = "Add to Cart";
      btn.classList.remove("in-cart");
      btn.style.backgroundColor = "";
      btn.style.color = "";
    } else {
      addToCart(product);
      btn.textContent = "Remove from Cart";
      btn.classList.add("in-cart");
      btn.style.backgroundColor = "red";
      btn.style.color = "#fff";
    }
  }

  // heart button (favorite)
  if(e.target.closest('.heart-btn')) {
    if(!requireLogin()) return;

    const heartBtn = e.target.closest('.heart-btn');
    const idx = parseInt(heartBtn.getAttribute("data-index"), 10);
    const product = products[idx];

    if(favorites.includes(product.name)) {
      favorites = favorites.filter(n => n !== product.name);
    } else {
      favorites.push(product.name);
    }
    localStorage.setItem("favorites", JSON.stringify(favorites));
    renderProducts(products);
  }
});

// --- Cart Popup Toggle ---
cartIcon.addEventListener("click",()=>{
  if(!requireLogin()) return;
  cartPopup.style.display = cartPopup.style.display==="block"?"none":"block";
});

// --- Quantity controls ---
cartItems.addEventListener("click", (e) => {
  const idx = e.target.getAttribute("data-index");
  if (idx === null) return;
  const index = parseInt(idx, 10);
  if (e.target.classList.contains("increase")) {
    cart[index].quantity++;
    saveCart();
  } else if (e.target.classList.contains("decrease")) {
    cart[index].quantity--;
    if (cart[index].quantity <= 0) cart.splice(index, 1);
    saveCart();
  }
});

// --- Search ---
const searchType = document.getElementById("search-type");
const searchInput = document.getElementById("search-input");
const searchButton = document.getElementById("search-button");

function searchProducts() {
  const type = searchType.value;
  const query = searchInput.value.toLowerCase().trim();
  const filtered = products.filter(product=>{
    if(type==="name") return product.name.toLowerCase().includes(query);
    if(type==="category") return product.category.toLowerCase().includes(query);
  });
  renderProducts(filtered);
}
searchButton.addEventListener("click",searchProducts);
searchInput.addEventListener("input",searchProducts);

// --- Auth ---
const authArea = document.getElementById("auth-area");
const userArea = document.getElementById("user-area");
const welcomeText = document.getElementById("welcome-text");
const logoutBtn = document.getElementById("logout-btn");

function checkLogin() {
  const currentUser = getCurrentUser();
  if(currentUser) {
    authArea.style.display = "none";
    userArea.style.display = "flex";
    welcomeText.textContent = `Hallo, ${currentUser.firstname} ${currentUser.lastname}`;
  } else {
    authArea.style.display = "flex";
    userArea.style.display = "none";
  }
}

// --- Logout with reset ---
logoutBtn.addEventListener("click",()=>{
  // Clear login
  localStorage.removeItem("currentUser");
  sessionStorage.removeItem("currentUser");

  // Clear cart and favorites
  cart = [];
  favorites = [];
  localStorage.removeItem("cart");
  localStorage.removeItem("favorites");

  // Reset UI
  updateCartUI();
  renderProducts(products);
  checkLogin();
});

checkLogin();
updateCartUI();

// --- Add-all-products ---
document.getElementById("add-all-products-btn").addEventListener("click", () => {
  if(!requireLogin()) return;
  window.location.href = "allproducts.html";
});

// --- Favorite Products ---
document.getElementById("favorite-products-btn").addEventListener("click", () => {
  if(!requireLogin()) return;
  window.location.href = "favorite.html";
});
</script>

</body>
</html>
